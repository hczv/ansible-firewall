# ===========================================
# BASIC SETTINGS
# ===========================================

# Standard HTTP proxy port
http_port 3128

# ===========================================
# DISABLE CACHING COMPLETELY
# ===========================================

# Disable all caching
cache deny all

# No memory cache
cache_mem 0 MB

# No disk cache
cache_dir null /tmp

# Disable store
maximum_object_size 0 KB

# ===========================================
# AUTHENTICATION (Basic Auth)
# ===========================================

# Basic authentication using htpasswd file
auth_param basic program {{ squid_basic_ncsa_auth_path }} {{ squid_passwd_path }}
auth_param basic children 5 startup=1 idle=1
auth_param basic realm Squid Proxy Authentication
auth_param basic credentialsttl 2 hours

# ===========================================
# ACL DEFINITIONS
# ===========================================

# --- Standard Port ACLs ---
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https

# Method ACLs
acl CONNECT method CONNECT

{% for whitelist_ip in (squid_whitelist_ips | default([])) %}
{% for ip in (whitelist_ip.ips | default([])) %}
acl {{ whitelist_ip.name }}_ips src {{ ip }}
{% endfor %}
{% endfor %}

# --- IP/Subnet Based ACLs ---
# Group 1: Office network
#acl ip_office src 192.168.1.0/24

# Group 2: Specific server
#acl ip_server src 10.0.0.0/8

# Group 3: VPN network
#acl ip_vpn src 172.16.0.0/16

# Group 4: Management IPs
#acl ip_management src 192.168.100.10 192.168.100.11 192.168.100.12

# Localhost
acl localhost src 127.0.0.1/32 ::1

# --- User Based ACLs ---
acl authenticated proxy_auth REQUIRED

# Individual users and groups
{% for whitelist_user in (squid_whitelist_users | default([])) %}
acl user_{{ whitelist_user.username }} proxy_auth {{ whitelist_user.username }}
{% endfor %}

#acl user_admin proxy_auth admin administrator
#acl user_developer proxy_auth developer john jane bob alice
#acl user_marketing proxy_auth marketing sarah mike lisa
#acl user_support proxy_auth support helpdesk

# ===========================================
# DOMAIN ACLs (for both HTTP and HTTPS)
# ===========================================

# --- Domains for IP-based access ---

squid_whitelists: []
#- name: update-sites
#  domains:
#  - mirrors.almalinux.org

{% for whitelist_domains in (squid_whitelists | default([])) %}
{% for domain in (whitelist_domains.domains | default([])) %}
acl whitelist_{{ whitelist_domains.name }} dstdomain {{ domain }}
{% endfor %}
{% endfor %}

# Domains for office network (Group 1)
#acl domains_office dstdomain .google.com
#acl domains_office dstdomain .google.co.uk
#acl domains_office dstdomain .googleapis.com
#acl domains_office dstdomain .gstatic.com
#acl domains_office dstdomain .github.com
#acl domains_office dstdomain .githubusercontent.com
#acl domains_office dstdomain .stackoverflow.com
#acl domains_office dstdomain .stackexchange.com
#acl domains_office dstdomain .microsoft.com
#acl domains_office dstdomain .office.com
#acl domains_office dstdomain .office365.com
#acl domains_office dstdomain .live.com
#acl domains_office dstdomain .windows.net
#
## Domains for specific server (Group 2)
#acl domains_server dstdomain .internal-api.company.com
#acl domains_server dstdomain .api.company.com
#acl domains_server dstdomain .services.company.com
#acl domains_server dstdomain .updates.company.com
#acl domains_server dstdomain .google.com
#
## Domains for VPN network (Group 3)
#acl domains_vpn dstdomain .azure.com
#acl domains_vpn dstdomain .amazonaws.com
#acl domains_vpn dstdomain .aws.amazon.com
#acl domains_vpn dstdomain .cloudflare.com
#
## Domains for management IPs
#acl domains_management dstdomain .company.com
#acl domains_management dstdomain .internal.company.com
#
# --- Domains for User-based access ---
#
## Developer domains
#acl domains_developer dstdomain .github.com
#acl domains_developer dstdomain .githubusercontent.com
#acl domains_developer dstdomain .gitlab.com
#acl domains_developer dstdomain .bitbucket.org
#acl domains_developer dstdomain .stackoverflow.com
#acl domains_developer dstdomain .stackexchange.com
#acl domains_developer dstdomain .npmjs.com
#acl domains_developer dstdomain .npmjs.org
#acl domains_developer dstdomain .yarnpkg.com
#acl domains_developer dstdomain .pypi.org
#acl domains_developer dstdomain .pypi.python.org
#acl domains_developer dstdomain .pythonhosted.org
#acl domains_developer dstdomain .docker.com
#acl domains_developer dstdomain .docker.io
#acl domains_developer dstdomain .hub.docker.com
#acl domains_developer dstdomain .maven.org
#acl domains_developer dstdomain .maven.apache.org
#acl domains_developer dstdomain .rubygems.org
#acl domains_developer dstdomain .packagist.org
#acl domains_developer dstdomain .nuget.org
#acl domains_developer dstdomain .crates.io
#acl domains_developer dstdomain .golang.org
#acl domains_developer dstdomain .pkg.go.dev
#acl domains_developer dstdomain .rust-lang.org
#acl domains_developer dstdomain .docs.rs
#acl domains_developer dstdomain .mozilla.org
#acl domains_developer dstdomain .developer.mozilla.org
#acl domains_developer dstdomain .w3.org
#
## Marketing domains
#acl domains_marketing dstdomain .google.com
#acl domains_marketing dstdomain .googleapis.com
#acl domains_marketing dstdomain .googletagmanager.com
#acl domains_marketing dstdomain .google-analytics.com
#acl domains_marketing dstdomain .analytics.google.com
#acl domains_marketing dstdomain .facebook.com
#acl domains_marketing dstdomain .fb.com
#acl domains_marketing dstdomain .fbcdn.net
#acl domains_marketing dstdomain .instagram.com
#acl domains_marketing dstdomain .linkedin.com
#acl domains_marketing dstdomain .licdn.com
#acl domains_marketing dstdomain .twitter.com
#acl domains_marketing dstdomain .x.com
#acl domains_marketing dstdomain .twimg.com
#acl domains_marketing dstdomain .youtube.com
#acl domains_marketing dstdomain .youtu.be
#acl domains_marketing dstdomain .ytimg.com
#acl domains_marketing dstdomain .hootsuite.com
#acl domains_marketing dstdomain .buffer.com
#acl domains_marketing dstdomain .mailchimp.com
#acl domains_marketing dstdomain .hubspot.com
#acl domains_marketing dstdomain .salesforce.com
#acl domains_marketing dstdomain .canva.com
#acl domains_marketing dstdomain .adobe.com
#acl domains_marketing dstdomain .creativecloud.com
#
## Support domains
#acl domains_support dstdomain .zendesk.com
#acl domains_support dstdomain .freshdesk.com
#acl domains_support dstdomain .intercom.com
#acl domains_support dstdomain .slack.com
#acl domains_support dstdomain .slack-edge.com
#acl domains_support dstdomain .teams.microsoft.com
#acl domains_support dstdomain .zoom.us
#acl domains_support dstdomain .zoom.com
#acl domains_support dstdomain .webex.com
#acl domains_support dstdomain .gotomeeting.com
#
## --- Common/Shared domains (allowed for all authenticated users) ---
#acl domains_common dstdomain .company.com
#acl domains_common dstdomain .google.com
#acl domains_common dstdomain .gstatic.com

# ===========================================
# HTTP ACCESS RULES
# ===========================================

# --- Security Rules (First) ---

# Deny requests to unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# --- Allow localhost (no auth required) ---
#http_access allow localhost

# ===========================================
# IP-BASED ACCESS RULES (No authentication)
# ===========================================

{% for whitelist_ip in (squid_whitelist_ips | default([])) %}
{% for whitelist in (whitelist_ip.whitelists | default([])) %}
http_access allow {{ whitelist_ip.name }}_ips whitelist_{{ whitelist }}
{% endfor %}
{% endfor %}

# Management IPs - access to company resources
http_access allow ip_management domains_management

# Office network - access to office domains
http_access allow ip_office domains_office

# Server - access to API/internal domains
http_access allow ip_server domains_server

# VPN network - access to cloud domains
http_access allow ip_vpn domains_vpn

# ===========================================
# USER-BASED ACCESS RULES (Requires authentication)
# ===========================================

{% for whitelist_user in (squid_whitelist_users | default([])) %}
{% for whitelist in (whitelist_user.whitelists | default([])) %}
http_access allow user_{{ whitelist_user.username }} whitelist_{{ whitelist_domains.name }}
{% endfor %}
{% endfor %}

# Admin users - FULL unrestricted access
#http_access allow user_admin

# Developers - access to development resources
#http_access allow user_developer domains_developer

# Marketing - access to marketing/social platforms
#http_access allow user_marketing domains_marketing

# Support - access to support tools
#http_access allow user_support domains_support

# All authenticated users - access to common domains
#http_access allow authenticated domains_common

# ===========================================
# DEFAULT DENY RULE (Must be last)
# ===========================================

# Deny everything else
http_access deny all

# ===========================================
# LOGGING CONFIGURATION
# ===========================================

# Standard log format
logformat combined %>a %[ui %[un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh

# Access log
access_log /var/log/squid/access.log combined

# Cache/debug log
cache_log /var/log/squid/cache.log

# Store log (disabled since no caching)
cache_store_log none

# Debug options (increase for troubleshooting)
debug_options ALL,1

# ===========================================
# MISCELLANEOUS SETTINGS
# ===========================================

# Visible hostname in error pages
visible_hostname squid-proxy.company.com

# Admin email for error pages
cache_mgr proxy-admin@company.com

# Coredump directory
coredump_dir /var/spool/squid

# Shutdown lifetime
shutdown_lifetime 3 seconds

# DNS settings
dns_v4_first on

# Client request limits
request_header_max_size 64 KB
request_body_max_size 0 KB

# Connection timeouts
connect_timeout 60 seconds
read_timeout 15 minutes
client_lifetime 1 day

# Forwarded-For header (privacy consideration)
forwarded_for delete

# Via header
via off
