---
# tasks file for ansible-squid
- name: Install squid
  package:
    name: squid
    state: present

- name: Install apache2-utils for htpasswd
  package:
    name: 
      - apache2-utils
      - python3-passlib
    state: present
  when: squid_whitelist_users | default([]) | length > 0

- name: Validate auth user entries
  assert:
    that:
      - "item.username is defined"
      - "item.password is defined"
    fail_msg: "Each entry in squid_users (or squid_auth_users) must include 'username' and 'password'"
  loop: "{{ squid_whitelist_users | default([]) }}"
  when: squid_whitelist_users | default([]) | length > 0

- name: Create squid password file directory
  file:
    path: /etc/squid
    state: directory
    mode: '0755'
- name: Create squid password file
  htpasswd:
    path: "{{ squid_passwd_path }}"
    name: "{{ item.username }}"
    password: "{{ item.password }}"
    owner: "{{ squid_user }}"
    group: "{{ squid_group }}"
    mode: '0640'
  loop: "{{ squid_whitelist_users | default([]) }}"
  no_log: true
  when: squid_whitelist_users | default([]) | length > 0

- name: Render squid configuration
  template:
    src: squid.conf.j2
    dest: "{{ squid_conf_path }}"
    owner: root
    group: root
    mode: '0644'
  notify: restart squid

- name: Ensure squid service is running and enabled
  service:
    name: squid
    state: started
    enabled: true
